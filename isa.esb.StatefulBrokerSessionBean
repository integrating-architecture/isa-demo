/*Copyright Â© by Andreas Weidinger - Integrating Architecture.
All rights reserved.

Redistribution and use in source and binary forms, with or without modification, are permitted
provided that the following conditions are met:

  1. Redistribution and use are in compliance to the license
     or description of conditions named and/or described by the following file or text:
     
     www.integrating-architecture.de/licenses/LICENSE-1.0

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, 
THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR 
PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER BE LIABLE 
FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL 
DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR 
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER 
CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, 
OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE 
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.*/
package isa.esb;

import isa.Bootstrap;
import isa.ByteData;
import isa.SessionContextAdapter;
import isa.StatefulCallHandler;

import javax.annotation.PreDestroy;
import javax.annotation.Resource;
import javax.ejb.PostActivate;
import javax.ejb.PrePassivate;
import javax.ejb.Remove;
import javax.ejb.SessionContext;
import javax.ejb.Stateful;
import javax.ejb.TransactionManagement;
import javax.ejb.TransactionManagementType;

/**<pre>
 *</pre>
 * @author A.Weidinger
 */
@Stateful
@TransactionManagement(TransactionManagementType.CONTAINER)
public class StatefulBrokerSessionBean implements BrokerSession {

	//ISA
	protected transient StatefulCallHandler handler = null;
	protected ByteData handlerState = null;

	//EJB
	protected SessionContext ctx = null;

	/**
	 */
    public StatefulBrokerSessionBean() {
    }
    
	/**
	 */
	public void initSession(Object pConfig)throws Exception{
		if(handler==null){
			handlerState = null;
			SessionContextAdapter lCtx = new SessionContextAdapterImpl(ctx);
			handler = Bootstrap.getCurrent().getStatefulCallHandler(pConfig, lCtx);
		}else{
			throw new Exception("Illegal Initialization call on existing Session");
		}
		handler.postInitSession(pConfig);
	}

	/**
	 */
	public Object call(Object pDescr)throws Exception{
		Object lRet = handler.call(pDescr);
		return lRet;
	}

	/**
	 */
	public Object call(Object pDescr, Object pParams)throws Exception{
		Object lRet = handler.call(pDescr, pParams);
		return lRet;		
	}
	
	@PreDestroy
	public void preDestroy() {
		if(handler!=null){handler.close("PreDestroy");}
	}
	
	@PrePassivate
	public void prePassivate() {
		try {
			//passivate the StatefulCallHandler
			if(handler!=null){
				handler.passivate("PrePassivate");
				//save the passivated handler
				//as ByteData in this session
				handlerState = Bootstrap.getCurrent().toByteData(handler);
			}
		}catch(Exception e) {
			Bootstrap.log("ErrorLevel", "Error trying to passivate Stateful Session Bean Callhandler", e);
		}finally{
			//null the origin handler
			handler = null;
		}
	}
	
	@PostActivate
	public void postActivate() {
		try {
			if(handlerState!=null){
				//deserialize the handlerState ByteData
				//to a StatefulCallHandler
				handler = (StatefulCallHandler)Bootstrap.getCurrent().fromByteData(handlerState);
				//create a new context adapter
				SessionContextAdapter lCtx = new SessionContextAdapterImpl(ctx);
				//and activate the handler
				Object lToDo = handler.activate(lCtx, "PostActivate");
				//do what the handler wants
				if(lToDo.equals("close")){
					handler.close("close.PostActivate");
				}
			}
		}catch(Exception e) {
			Bootstrap.log("ErrorLevel", "Error trying to activate Stateful Session Bean Callhandler", e);
		}finally{
			//null the handler state
			handlerState = null;
		}
	}

	@Remove
	public void closeSession(Object pInfo) {
		if(handler!=null){
			handler.close("Remove");
			handler = null;
			handlerState = null;
		}
	} 
	
	@Resource
	public void setSessionContext(SessionContext pCtx){
		ctx = pCtx;
	}
}
